<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>××¤×ª ×ª×§×¦×™×‘ ×”××“×™× ×” - ×¤×¨×•×¤×•×¨×¦×™×•×ª</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #0f1117;
      color: #fff;
      min-height: 100vh;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .container {
      width: 100%;
      max-width: 1000px;
    }

    h1 {
      text-align: center;
      font-size: 1.8rem;
      margin-bottom: 6px;
      font-weight: 700;
    }

    .subtitle {
      text-align: center;
      color: #aaa;
      font-size: 0.95rem;
      margin-bottom: 24px;
    }

    .analogy {
      background: linear-gradient(135deg, #1a1f2e, #252b3b);
      border: 1px solid #3a4060;
      border-radius: 12px;
      padding: 16px 24px;
      text-align: center;
      margin-bottom: 28px;
      font-size: 0.95rem;
      color: #ccd;
      line-height: 1.7;
    }

    .analogy strong {
      color: #7eb8f7;
    }

    .section {
      background: #1a1f2e;
      border-radius: 14px;
      padding: 18px 22px;
      border: 1px solid #2a2f4e;
      margin-bottom: 28px;
    }

    .section-title {
      font-size: 1rem;
      font-weight: 700;
      color: #aab;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid #2a2f4e;
    }

    #treemap {
      width: 100%;
      height: 420px;
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      background: #12141c;
    }

    @media (max-width: 600px) {
      #treemap {
        height: 550px;
      }
    }

    .tm-cell {
      position: absolute;
      border: 2px solid #0f1117;
      border-radius: 4px;
      cursor: pointer;
      transition: filter .15s;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 4px;
    }

    .tm-cell:hover {
      filter: brightness(1.3);
      z-index: 10;
    }

    .tm-label {
      font-size: clamp(.65rem, 1.4vw, .95rem);
      font-weight: 700;
      color: rgba(255, 255, 255, .95);
      text-shadow: 0 1px 3px rgba(0, 0, 0, .7);
      line-height: 1.3;
    }

    .tm-pct {
      font-size: clamp(.7rem, 1.5vw, 1rem);
      font-weight: 800;
      color: #fff;
      margin-top: 3px;
    }

    .tm-val {
      font-size: clamp(.55rem, 1.1vw, .8rem);
      color: rgba(255, 255, 255, .8);
      margin-top: 2px;
    }

    /* Expanded cell overlay */
    .tm-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 900;
      opacity: 0;
      transition: opacity .25s ease;
      cursor: pointer;
      display: none;
    }

    .tm-overlay.active {
      opacity: 1;
    }

    .tm-expanded {
      position: fixed;
      z-index: 950;
      border-radius: 16px;
      padding: 28px 24px;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      max-width: 90vw;
      max-height: 85vh;
      width: 380px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.6);
      opacity: 0;
      transition: transform .3s cubic-bezier(.17,.67,.4,1.1), opacity .25s ease;
      pointer-events: none;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6), 0 0 40px rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(255, 255, 255, 0.15);
      overflow-y: auto;
    }

    .tm-expanded.active {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
      pointer-events: auto;
    }

    .tm-expanded .exp-close {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background .15s;
    }

    .tm-expanded .exp-close:hover {
      background: rgba(0, 0, 0, 0.7);
    }

    .tm-expanded .exp-name {
      font-size: 1.4rem;
      font-weight: 800;
      color: #fff;
      text-shadow: 0 2px 6px rgba(0, 0, 0, .5);
      margin-bottom: 4px;
    }

    .tm-expanded .exp-sub {
      font-size: 0.95rem;
      color: rgba(255, 255, 255, .75);
      margin-bottom: 12px;
    }

    .tm-expanded .exp-desc {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, .85);
      line-height: 1.5;
      margin-bottom: 18px;
      padding: 0 8px;
    }

    .tm-expanded .exp-stats {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .tm-expanded .exp-stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(0, 0, 0, 0.25);
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .tm-expanded .exp-stat-label {
      color: rgba(255, 255, 255, .7);
    }

    .tm-expanded .exp-stat-val {
      font-weight: 700;
      color: #fff;
      font-size: 1rem;
    }

    @media (max-width: 600px) {
      .tm-expanded {
        width: 92vw;
        padding: 22px 16px;
      }

      .tm-expanded .exp-name {
        font-size: 1.2rem;
      }
    }

    @media (max-width: 600px) {
      body {
        padding: 12px;
      }

      h1 {
        font-size: 1.5rem;
      }

      .subtitle {
        font-size: 0.85rem;
      }

      .analogy {
        padding: 12px 16px;
        font-size: 0.85rem;
      }

      .section {
        padding: 14px 16px;
      }

    }

    #tooltip {
      position: fixed;
      background: rgba(10, 12, 22, .97);
      border: 1px solid #4a5080;
      border-radius: 10px;
      padding: 12px 16px;
      font-size: .85rem;
      color: #dde;
      pointer-events: none;
      z-index: 1000;
      max-width: 260px;
      display: none;
      direction: rtl;
    }

    .tt-title {
      font-weight: 700;
      font-size: .95rem;
      margin-bottom: 6px;
    }

    .tt-row {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      margin-top: 4px;
      font-size: .82rem;
    }

    .tt-val {
      color: #7eb8f7;
      font-weight: 600;
    }

    .footnote {
      text-align: center;
      font-size: .75rem;
      color: #556;
      margin-top: 10px;
    }

    /* Calculator Styles */
    .calc-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .calc-input-row {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: center;
      background: #232840;
      padding: 16px;
      border-radius: 10px;
    }

    .calc-input-row input {
      background: #0f1117;
      border: 1px solid #3a4060;
      color: #fff;
      padding: 10px 14px;
      border-radius: 6px;
      font-size: 1.1rem;
      width: 120px;
      text-align: center;
      font-weight: 700;
    }

    .calc-input-row label {
      font-weight: 600;
      color: #dde;
    }

    .calc-results {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }

    .calc-card {
      background: #1a1f2e;
      border: 1px solid #2a2f4e;
      padding: 12px;
      border-radius: 10px;
      text-align: center;
    }

    .calc-card-val {
      font-size: 1.2rem;
      font-weight: 800;
      color: #7eb8f7;
      margin-bottom: 4px;
    }

    .calc-card-lbl {
      font-size: 0.82rem;
      color: #99a;
    }

    /* Per Capita & Personal Tax Styles */
    .pc-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    .pc-card {
      background: #232840;
      border-radius: 10px;
      padding: 14px;
      text-align: center;
      border-bottom: 3px solid;
    }

    .pc-card-val {
      font-size: 1.1rem;
      font-weight: 800;
      margin-bottom: 4px;
    }

    .pc-card-lbl {
      font-size: 0.8rem;
      color: #aaa;
    }

    /* Per Capita Tabs */
    .pc-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 16px;
      background: #0f1117;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #2a2f4e;
      width: fit-content;
    }

    .pc-tab {
      padding: 8px 20px;
      font-size: 0.85rem;
      font-weight: 600;
      color: #99a;
      cursor: pointer;
      transition: background .15s, color .15s;
      border: none;
      background: transparent;
    }

    .pc-tab.active {
      background: #7eb8f7;
      color: #0f1117;
    }

    .pc-tab:hover:not(.active) {
      background: #1a1f2e;
      color: #dde;
    }

    .pc-total {
      margin-top: 16px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .pc-total-card {
      background: linear-gradient(135deg, #232840, #1a2a3a);
      border-radius: 10px;
      padding: 14px;
      text-align: center;
      border: 1px solid #3a4060;
    }

    .pc-total-val {
      font-size: 1.3rem;
      font-weight: 800;
      color: #7eb8f7;
      margin-bottom: 4px;
    }

    .pc-total-lbl {
      font-size: 0.82rem;
      color: #aab;
    }

    .tax-container {
      background: linear-gradient(135deg, #1a2a3a, #1a1f2e);
      border: 1px solid #3a5060;
    }

    .tax-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .tax-input-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-bottom: 24px;
    }

    .tax-results-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .tax-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .tax-row-bar-wrap {
      flex-grow: 1;
      margin: 0 15px;
      height: 6px;
      background: #0f1117;
      border-radius: 3px;
      overflow: hidden;
    }

    .tax-row-bar {
      height: 100%;
      border-radius: 3px;
    }

    .tax-row-val {
      font-weight: 700;
      min-width: 60px;
      text-align: left;
    }

    /* Global Comparison Styles */
    .global-section {
      background: #1e2535;
      border: 1px dashed #4b5563;
    }

    .global-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 15px;
    }

    .global-card {
      background: rgba(15, 23, 42, 0.4);
      padding: 18px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .global-card-title {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 15px;
      border-bottom: 1px solid #334155;
      padding-bottom: 8px;
      display: flex;
      justify-content: space-between;
    }

    .g-bar-row {
      margin-bottom: 12px;
    }

    .g-bar-lbl {
      display: flex;
      justify-content: space-between;
      font-size: 0.82rem;
      margin-bottom: 4px;
      color: #94a3b8;
    }

    .g-bar-track {
      height: 8px;
      background: #0f172a;
      border-radius: 4px;
      overflow: hidden;
    }

    .g-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 1s ease-out;
    }

    /* Slider Styles */
    .slider-wrap {
      width: 100%;
      margin-top: 10px;
    }

    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 6px;
      background: #334155;
      border-radius: 3px;
      outline: none;
      margin: 15px 0;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: #7eb8f7;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid #1a1f2e;
      box-shadow: 0 0 10px rgba(126, 184, 247, 0.4);
    }

    input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: #7eb8f7;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid #1a1f2e;
      box-shadow: 0 0 10px rgba(126, 184, 247, 0.4);
    }

    /* Nav */
    .nav {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 22px;
    }
    .nav a {
      color: #7eb8f7;
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 600;
      padding: 8px 18px;
      border-radius: 8px;
      border: 1px solid #2a2f4e;
      background: #1a1f2e;
      transition: background .15s, border-color .15s;
    }
    .nav a:hover { background: #252b3b; border-color: #7eb8f7; }
    .nav a.active { background: #7eb8f7; color: #0f1117; border-color: #7eb8f7; }
  </style>
</head>

<body>

  <div class="container">
    <nav class="nav">
      <a href="index.html" class="active">×ª×§×¦×™×‘ ×”××“×™× ×”</a>
      <a href="municipality.html">×”×¢×™×¨×™×™×” ×©×œ×š</a>
    </nav>
    <h1>ğŸ“Š ××¤×ª ×ª×§×¦×™×‘ ×™×©×¨××œ â€” ×¤×¨×•×¤×•×¨×¦×™×•×ª ×××™×ª×™×•×ª</h1>
    <div class="subtitle">×ª×§×¦×™×‘ 2024 | â‚ª628 ××™×œ×™××¨×“ | ×”×•×¦××•×ª ×××©×œ×ª×™×•×ª</div>

    <div class="analogy">
      ğŸ’¡ <strong>×× ×œ×•×’×™×”:</strong> ×× ×ª×§×¦×™×‘ ×”××“×™× ×” = ××©×›×•×¨×ª ×—×•×“×©×™×ª ×©×œ â‚ª10,000 â€”<br>
      ×”×•× ××” ×©×œ <strong>××™×œ×™×•×Ÿ â‚ª</strong> = ××™×‘×•×“ <strong>â‚ª1.6 ×‘×œ×‘×“</strong> ×××•×ª×” ××©×›×•×¨×ª.<br>
      ×‘×–×‘×•×– ×××©×œ×ª×™ ×©×œ <strong>â‚ª20 ××™×œ×™××¨×“</strong> = ×œ×‘×–×‘×– <strong>â‚ª318 ×‘×—×•×“×©</strong> ×œ×œ× ×¡×™×‘×”.
    </div>

    <div class="section">
      <div class="section-title">ğŸ—ºï¸ ××¤×ª ×¢×•××§ â€” ×’×•×“×œ ×›×œ ×¨×™×‘×•×¢ = ×—×œ×§ ×™×—×¡×™ ××”×ª×§×¦×™×‘</div>
      <div id="treemap"></div>
      <!-- legend removed -->
      <div class="section-title" style="margin-top:24px; border-bottom:none; color:#7eb8f7;">ğŸ‘¥ ×›××” ×›×¡×£ ×”××“×™× ×” ××©×§×™×¢×” ×‘×š <span id="pcPeriodLabel">×‘×›×œ ×©× ×”</span> (×œ×¤×™ ×ª×—×•×)</div>
      <div class="pc-tabs">
        <button class="pc-tab active" onclick="switchPcTab('yearly', this)">×©× ×ª×™</button>
        <button class="pc-tab" onclick="switchPcTab('monthly', this)">×—×•×“×©×™</button>
      </div>
      <div class="pc-grid" id="pcGrid"></div>
      <div class="pc-total" id="pcTotal"></div>
    </div>

    <div class="analogy" style="border-color:#5a3a7a; background:linear-gradient(135deg,#1e1a2e,#2a1f3e);">
      âš–ï¸ <strong style="color:#cc88ff;">×¤×¨×“×•×§×¡:</strong> ×”×‘×–×‘×•×– ×”×‘×™×•×¨×•×§×¨×˜×™ (â‚ª15â€“30 ××™×œ×™××¨×“/×©× ×”) ×’×“×•×œ <strong style="color:#ff6688;">×¤×™ 37â€“75</strong> ××ª×§×¦×™×‘ ×”××›×™×¤×” ×”×›×œ×›×œ×™×ª (â‚ª2â€“5 ××™×œ×™×•×Ÿ ×œ×ª×™×§).
    </div>

    <div class="section">
      <div class="section-title">âœ¨ ××—×©×‘×•×Ÿ ×¤×¨×¡×¤×§×˜×™×‘×” â€” ×›××” ×–×” "×”×¨×‘×”" ×‘×©×‘×™×œ ×”××“×™× ×”?</div>
      <div class="calc-container">
        <input type="hidden" id="calcInput" value="1000000">
        <div id="calcAmountDisplay"
          style="text-align:center; font-size:1.15rem; font-weight:700; color:#7eb8f7; margin-bottom:8px;">
        </div>
        <div class="slider-wrap">
          <input type="range" id="calcSlider" min="0" max="1000" step="1" value="341"
            oninput="onCalcSlider()">
          <div style="display:flex; justify-content:space-between; font-size:0.75rem; color:#667;">
            <span>××œ×£ â‚ª</span>
            <span>××™×œ×™××¨×“×™ â‚ª</span>
          </div>
        </div>
        <div id="calcAnalogy"
          style="text-align:center; padding:12px 16px; border-radius:10px; background:#232840; margin-bottom:4px;">
        </div>
        <div class="calc-results" id="calcResults"></div>
        <p style="font-size:0.88rem; color:#aaa; margin-top:14px; text-align:center; line-height:1.5;">
          ×”×–×™×–×• ××ª ×”×¡×¨×’×œ ×•×ª×¨××• ×›××” ×”×¡×›×•× ×‘×××ª ×©×•×•×” â€” ×‘××—×•×–×™×, ×‘××©×›×•×¨×ª ×©×œ×›×, ×•×‘×”×©×•×•××” ×œ××” ×©×§×•×¨×” ×‘×¤×•×¢×œ.
        </p>
        <div style="margin-top:10px; font-size:0.8rem; color:#778; text-align:center; line-height:1.5;">
          ğŸ’¡ ×”××“×™× ×” "×—×•×¡×›×ª" ×××•×ª ××™×œ×™×•× ×™× ×‘××›×™×¤×” â€” ×•××‘×–×‘×–×ª ×¢×©×¨×•×ª ××™×œ×™××¨×“×™× ××‘×¤× ×™×.
        </div>
      </div>
    </div>

    <div class="section tax-container">
      <div class="section-title">ğŸ’° ××—×©×‘×•×Ÿ "×›××” ×× ×™ ××©×œ×"? â€” ×”×”×©×¤×¢×” ×”××™×©×™×ª ×©×œ ×”××¡×™× ×©×œ×š</div>
      <div class="tax-header">
        <p style="font-size:0.9rem; color:#aaa; margin-bottom:10px;">×‘×”×ª×‘×¡×¡ ×¢×œ ×”××¡×™× ×©××ª×” ××©×œ× (××¢"×, ×”×›× ×¡×”, ×‘×¨×™××•×ª
          ×•×›×•'), ×œ××Ÿ ×”×•×œ×š ×”×›×¡×£ ×©×œ×š ×‘×©× ×”?</p>
      </div>
      <div class="tax-input-wrap">
        <label>×¡×”"×› ××¡×™× ×—×•×“×©×™×™× (××©×•×¢×¨):</label>
        <div class="calc-input-row" style="background:transparent; padding:0;">
          <input type="number" id="taxInput" value="3000" step="100" min="0" max="100000"
            oninput="syncInputs('taxInput', 'taxSlider', updatePersonalTax)">
          <span style="font-weight:700; color:#dde; margin-right:10px;">â‚ª ×œ×—×•×“×©</span>
        </div>
        <div class="slider-wrap" style="max-width:400px; width:100%;">
          <input type="range" id="taxSlider" min="0" max="50000" step="100" value="3000"
            oninput="syncInputs('taxSlider', 'taxInput', updatePersonalTax)">
          <div style="display:flex; justify-content:space-between; font-size:0.75rem; color:#667;">
            <span>â‚ª0</span>
            <span>â‚ª50,000</span>
          </div>
        </div>
        <p style="font-size:0.85rem; color:#888;">(= â‚ª<span id="annualTaxSpan">36,000</span> ×‘×©× ×”)</p>
      </div>
      <div class="tax-results-list" id="taxResults"></div>
    </div>

    <div class="section global-section">
      <div class="section-title">ğŸŒ ×–×•×•×™×ª ×‘×™× ×œ××•××™×ª â€” ××™×š ×™×©×¨××œ × ×¨××™×ª ××•×œ ×”×¢×•×œ×?</div>
      <p style="font-size:0.9rem; color:#aaa; margin-bottom:20px; text-align:center;">×”×©×•×•××ª ××—×•×– ××”×ª×"×’ (GDP) ×‘×™×Ÿ ×™×©×¨××œ
        ×œ××“×™× ×•×ª OECD ×•×’×•×¨××™× ×¢×•×œ××™×™×.</p>
      <div class="global-grid" id="globalGrid"></div>
      <div
        style="margin-top:25px; background:rgba(255,255,255,0.03); padding:15px; border-radius:8px; border-right:4px solid #7eb8f7;">
        <div style="font-weight:700; color:#dde; margin-bottom:5px;">ğŸ’¡ × ×§×•×“×” ×œ××—×©×‘×”:</div>
        <div style="font-size:0.92rem; color:#aaa; line-height:1.5;">×™×©×¨××œ ××•×¦×™××” ×¢×œ ×‘×™×˜×—×•×Ÿ ×¤×™ 3-4 ××”×××•×¦×¢ ×‘××™×¨×•×¤×”. ×”×¤×¢×¨
          ×”×–×” (×©×œ ×›-4% ××”×ª×"×’) ×©×•×•×” ×œ×›-70 ××™×œ×™××¨×“ ×©"×— ×‘×©× ×” â€” ×¡×›×•× ×©×‘×• × ×™×ª×Ÿ ×”×™×” ×œ×”×›×¤×™×œ ××ª ×ª×§×¦×™×‘ ×”×‘×¨×™××•×ª ×•×”×”×©×›×œ×” ×”×’×‘×•×”×” ×’×
          ×™×—×“.</div>
      </div>
    </div>

    <div class="footnote">* × ×ª×•× ×™× ××‘×•×¡×¡×™× ×¢×œ ×ª×§×¦×™×‘ ×”××“×™× ×” 2024. ×—×œ×§ ××”× ×ª×•× ×™× ×”× ×”×¢×¨×›×•×ª ×œ×¦×¨×›×™ ×”××—×©×”.</div>

  </div> <!-- end container -->

  <div id="tooltip"></div>
  <div class="tm-overlay" id="tmOverlay" onclick="closeExpanded()"></div>
  <div class="tm-expanded" id="tmExpanded"></div>

  <script>
    const TOTAL = 628;
    const cats = [
      { name: "×—×™× ×•×š (×™×¡×•×“×™ ×•×ª×™×›×•×Ÿ)", sub: "(×’× ×™×, ×‘×ª×™ ×¡×¤×¨)", v: 85, c: "#3b82f6", d: "×ª×§×¦×™×‘ ××¢×¨×›×ª ×”×—×™× ×•×š, ××•×¨×•×ª ×•×’× × ×•×ª" },
      { name: "×‘×¨×™××•×ª", sub: "(×‘×ª×™ ×—×•×œ×™×, ×§×•×¤\"×—)", v: 65, c: "#60a5fa", d: "××™××•×Ÿ ×¡×œ ×”×‘×¨×™××•×ª, ×‘×ª×™ ×—×•×œ×™× ×¦×™×‘×•×¨×™×™×" },
      { name: "×¨×•×•×—×” ×•×‘×™×˜×•×— ×œ××•××™", sub: "(×§×¦×‘××•×ª ×•×¡×™×•×¢)", v: 70, c: "#93c5fd", d: "×§×¦×‘××•×ª ×™×œ×“×™×, ×–×™×§× ×”, × ×›×•×ª ×•×¡×™×•×¢ ×¡×•×¦×™××œ×™" },
      { name: "×‘×™×˜×—×•×Ÿ (×¦×”\"×œ)", sub: "(×¦×‘× ×”×”×’× ×” ×œ×™×©×¨××œ)", v: 95, c: "#ef4444", d: "×ª×§×¦×™×‘ ×”×‘×™×˜×—×•×Ÿ ×”×©×•×˜×£, ×”×ª×¢×¦××•×ª ×•×›×•×— ××“×" },
      { name: "×‘×™×˜×—×•×Ÿ ×¤× ×™×", sub: "(××©×˜×¨×” ×•×©×‘\"×›)", v: 25, c: "#f87171", d: "××©×˜×¨×ª ×™×©×¨××œ, ×©×™×¨×•×ª×™ ×‘×™×˜×—×•×Ÿ, ×›×‘××•×ª ×•×”×¦×œ×”" },
      { name: "×©×™×¨×•×ª ×—×•×‘", sub: "(×¨×™×‘×™×ª ×¢×œ ××’\"×—)", v: 75, c: "#f59e0b", d: "×¨×™×‘×™×ª ×•×¤×™×¨×¢×•×Ÿ ×—×•×‘ ×œ××•××™ ×©×¦×‘×¨ ×œ××•×¨×š ×©× ×™×" },
      { name: "×ª×©×ª×™×•×ª ×•×ª×—×‘×•×¨×”", sub: "(×›×‘×™×©×™× ×•×¨×›×‘×ª)", v: 40, c: "#10b981", d: "×¡×œ×™×œ×ª ×›×‘×™×©×™×, ×¤×™×ª×•×— ×¨×›×‘×ª ×•×ª×©×ª×™×•×ª ×œ××•××™×•×ª" },
      { name: "×“×™×•×¨ ×•×©×™×›×•×Ÿ", sub: "(××¢× ×§×™× ×•×‘× ×™×™×”)", v: 15, c: "#34d399", d: "×¡×‘×¡×•×“ ××©×›× ×ª××•×ª, ×“×™×•×¨ ×¦×™×‘×•×¨×™ ×•×§×™×“×•× ×‘× ×™×™×”" },
      { name: "×”×’× ×ª ×”×¡×‘×™×‘×”", sub: "(×§×™×™××•×ª ×•×–×™×”×•×)", v: 12, c: "#a3e635", d: "×©××™×¨×” ×¢×œ ×”×˜×‘×¢, ×× ×™×¢×ª ×–×™×”×•×, ××—×–×•×¨ ×•×¤×™×§×•×—" },
      { name: "×××©×œ ×•××™× ×”×œ", sub: "(××©×¨×“×™× ×•×¨×©×•×™×•×ª)", v: 45, c: "#8b5cf6", d: "×××©×œ×”, ×›× ×¡×ª, ×¨×©×•×™×•×ª ×”××™× ×”×œ ×•×”×‘×™×•×¨×•×§×¨×˜×™×”" },
      { name: "×”×©×›×œ×” ×’×‘×•×”×”", sub: "(××•× ×™×‘×¨×¡×™×˜××•×ª)", v: 28, c: "#06b6d4", d: "××•× ×™×‘×¨×¡×™×˜××•×ª, ××›×œ×œ×•×ª, ××—×§×¨ ××§×“××™" },
      { name: "××—×§×¨ ×•×¤×™×ª×•×—", sub: "(×—×“×©× ×•×ª ×•×¡×˜××¨×˜××¤)", v: 22, c: "#fb923c", d: "R&D ××–×¨×—×™, ×ª××™×›×” ×‘×”×™-×˜×§ ×•×—×“×©× ×•×ª" },
      { name: "×“×ª ×•××’×–×¨", sub: "(×§×•××œ×™×¦×™×” + ×™×©×™×‘×•×ª)", v: 18, c: "#ec4899", d: "××•×¡×“×•×ª ×“×ª, ×™×©×™×‘×•×ª, ×”×¡×“×¨×™× ×§×•××œ×™×¦×™×•× ×™×™×" },
      { name: "×—×§×œ××•×ª", sub: "(×•×ª××™×›×•×ª ×¢× ×¤×™×•×ª)", v: 12, c: "#84cc16", d: "×—×§×œ××•×ª, ×“×™×’, ×”×’× ×ª ×”×¦×•××— ×•×ª××™×›×•×ª" },
      { name: "××—×¨ ×•×¨×–×¨×‘×•×ª", sub: "(×©×•× ×•×ª ×•×‘×¦\"×)", v: 21, c: "#6b7280", d: "×”×•×¦××•×ª ×©×•× ×•×ª, ×¨×–×¨×‘×•×ª ×œ×”×ª×¤×ª×—×•×™×•×ª ×‘×œ×ª×™ ×¦×¤×•×™×•×ª" },
    ];

    function squarify(items, x, y, w, h) {
      const cells = [];
      let rem = [...items].sort((a, b) => b.v - a.v);
      let cx = x, cy = y, cw = w, ch = h;
      const tot = rem.reduce((s, i) => s + i.v, 0);

      while (rem.length) {
        const side = Math.min(cw, ch);
        let row = [], rs = 0;
        for (let i = 0; i < rem.length; i++) {
          const cand = [...row, rem[i]], cs = rs + rem[i].v;
          // Convert value sum to area sum for comparison
          const areaSum = (cs / tot) * (w * h);
          const candAreas = cand.map(v => (v.v / tot) * (w * h));

          if (!row.length || worstArea(candAreas, side) <= worstArea(row.map(v => (v.v / tot) * (w * h)), side)) {
            row = cand; rs = cs;
          } else break;
        }
        rem = rem.slice(row.length);
        const areaSum = (rs / tot) * (w * h);
        if (cw >= ch) {
          const rw = areaSum / ch;
          let ry = cy;
          row.forEach(it => { const rh = ((it.v / tot) * (w * h)) / rw; cells.push({ ...it, x: cx, y: ry, w: rw, h: rh }); ry += rh; });
          cx += rw; cw -= rw;
        } else {
          const rh = areaSum / cw;
          let rx = cx;
          row.forEach(it => { const rw2 = ((it.v / tot) * (w * h)) / rh; cells.push({ ...it, x: rx, y: cy, w: rw2, h: rh }); rx += rw2; });
          cy += rh; ch -= rh;
        }
      }
      return cells;
    }

    function worstArea(rowAreas, side) {
      if (!rowAreas.length) return Infinity;
      const s = rowAreas.reduce((a, b) => a + b, 0);
      const mx = Math.max(...rowAreas);
      const mn = Math.min(...rowAreas);
      return Math.max((side * side * mx) / (s * s), (s * s) / (side * side * mn));
    }

    function renderTreemap() {
      const el = document.getElementById('treemap');
      const W = el.offsetWidth, H = el.offsetHeight;
      const cells = squarify(cats, 0, 0, W, H);
      el.innerHTML = '';
      cells.forEach(cell => {
        const pct = (cell.v / TOTAL * 100).toFixed(1);
        const d = document.createElement('div');
        d.className = 'tm-cell';
        d.style.cssText = `left:${cell.x}px;top:${cell.y}px;width:${cell.w}px;height:${cell.h}px;background:${cell.c};`;
        if (cell.w > 55 && cell.h > 36) {
          d.innerHTML = `<div class="tm-label">${cell.name}<br><span style="font-weight:400;font-size:.85em;opacity:.85">${cell.sub}</span></div>
        <div class="tm-pct">${pct}%</div>`;
        }
        d.addEventListener('mouseenter', e => showTT(e, cell, pct));
        d.addEventListener('mousemove', e => moveTT(e));
        d.addEventListener('mouseleave', hideTT);
        d.addEventListener('click', () => openExpanded(cell, pct));
        el.appendChild(d);
      });
      // legend removed
    }

    let pcMode = 'yearly';

    function switchPcTab(mode, btn) {
      pcMode = mode;
      document.querySelectorAll('.pc-tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('pcPeriodLabel').textContent = mode === 'yearly' ? '×‘×›×œ ×©× ×”' : '×‘×›×œ ×—×•×“×©';
      renderPerCapita();
    }

    function renderPerCapita() {
      const el = document.getElementById('pcGrid');
      const totalEl = document.getElementById('pcTotal');
      const sorted = [...cats].sort((a, b) => b.v - a.v);
      const isMonthly = pcMode === 'monthly';
      const divisor = isMonthly ? 12 : 1;

      el.innerHTML = sorted.map(c => {
        const val = Math.round(c.v * 100 / divisor);
        return `
        <div class="pc-card" style="border-color:${c.c}">
          <div class="pc-card-val" style="color:${c.c}">â‚ª${val.toLocaleString()}</div>
          <div class="pc-card-lbl">${c.name}</div>
        </div>`;
      }).join('');

      const totalYearly = cats.reduce((s, c) => s + c.v * 100, 0);
      const totalMonthly = Math.round(totalYearly / 12);

      totalEl.innerHTML = `
        <div class="pc-total-card">
          <div class="pc-total-val">â‚ª${totalYearly.toLocaleString()}</div>
          <div class="pc-total-lbl">×¡×”"×› ×©× ×ª×™ ×œ× ×¤×©</div>
        </div>
        <div class="pc-total-card">
          <div class="pc-total-val">â‚ª${totalMonthly.toLocaleString()}</div>
          <div class="pc-total-lbl">×¡×”"×› ×—×•×“×©×™ ×œ× ×¤×©</div>
        </div>`;
    }

    function updatePersonalTax() {
      const monthly = parseFloat(document.getElementById('taxInput').value) || 0;
      const annual = monthly * 12;
      document.getElementById('annualTaxSpan').innerText = annual.toLocaleString();
      const res = document.getElementById('taxResults');

      const sorted = [...cats].sort((a, b) => b.v - a.v);
      const maxPct = (sorted[0].v / TOTAL * 100);

      res.innerHTML = sorted.map(c => {
        const contrib = monthly * (c.v / TOTAL);
        const pct = (c.v / TOTAL * 100).toFixed(1);
        const barWidth = (parseFloat(pct) / maxPct * 100).toFixed(1);
        return `
        <div class="tax-row">
          <div style="width:140px; font-weight:600;">${c.name}</div>
          <div class="tax-row-bar-wrap">
            <div class="tax-row-bar" style="width:${barWidth}%; background:${c.c}"></div>
          </div>
          <div class="tax-row-val">â‚ª${contrib.toLocaleString(undefined, { maximumFractionDigits: 0 })} / ×—×•×“×©</div>
        </div>
      `;
      }).join('');
    }

    const globalData = [
      {
        title: "×”×•×¦××•×ª ×‘×™×˜×—×•×Ÿ", desc: "% ××”×ª×\"×’", color: "#ef4444",
        items: [
          { l: "×™×©×¨××œ (2024)", v: 5.3 },
          { l: "××¨×”\"×‘", v: 3.4 },
          { l: "×××•×¦×¢ OECD", v: 1.8 },
          { l: "×’×¨×× ×™×”/×¦×¨×¤×ª", v: 1.5 }
        ]
      },
      {
        title: "×”×•×¦××•×ª ×—×™× ×•×š", desc: "% ××”×ª×\"×’", color: "#3b82f6",
        items: [
          { l: "×™×©×¨××œ (×¦×™×‘×•×¨×™)", v: 7.2 },
          { l: "×××•×¦×¢ OECD", v: 5.1 },
          { l: "×‘×¨×™×˜× ×™×”", v: 4.8 }
        ]
      },
      {
        title: "×”×•×¦××•×ª ×‘×¨×™××•×ª", desc: "% ××”×ª×\"×’", color: "#10b981",
        items: [
          { l: "×××•×¦×¢ OECD", v: 9.2 },
          { l: "××¨×”\"×‘ (×¦×™×‘×•×¨×™+×¤×¨×˜×™)", v: 16.6 },
          { l: "×™×©×¨××œ", v: 7.5 }
        ]
      }
    ];

    function renderGlobal() {
      const el = document.getElementById('globalGrid');
      el.innerHTML = globalData.map(group => {
        const maxV = Math.max(...group.items.map(i => i.v));
        return `
          <div class="global-card">
            <div class="global-card-title">
              <span>${group.title}</span>
              <span style="font-size:0.75rem; color:#64748b; font-weight:400;">${group.desc}</span>
            </div>
            ${group.items.map(i => `
              <div class="g-bar-row">
                <div class="g-bar-lbl">
                  <span>${i.l}</span>
                  <span style="color:#dde; font-weight:700;">${i.v}%</span>
                </div>
                <div class="g-bar-track">
                  <div class="g-bar-fill" style="width:${(i.v / maxV * 100)}%; background:${group.color}"></div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }).join('');
    }

    // --- Calculator helpers ---
    const CALC_MIN_LOG = 3;          // log10(1,000)
    const CALC_MAX_LOG = 11.798;     // log10(628,000,000,000)
    const CALC_SLIDER_MAX = 1000;

    function sliderToValue(pos) {
      const log = CALC_MIN_LOG + (pos / CALC_SLIDER_MAX) * (CALC_MAX_LOG - CALC_MIN_LOG);
      return roundNice(Math.pow(10, log));
    }

    function valueToSlider(val) {
      const log = Math.log10(Math.max(1000, val));
      return Math.round(((log - CALC_MIN_LOG) / (CALC_MAX_LOG - CALC_MIN_LOG)) * CALC_SLIDER_MAX);
    }

    function roundNice(n) {
      if (n < 10000) return Math.round(n / 1000) * 1000;
      if (n < 100000) return Math.round(n / 5000) * 5000;
      if (n < 1000000) return Math.round(n / 50000) * 50000;
      if (n < 10000000) return Math.round(n / 500000) * 500000;
      if (n < 100000000) return Math.round(n / 5000000) * 5000000;
      if (n < 1000000000) return Math.round(n / 50000000) * 50000000;
      if (n < 10000000000) return Math.round(n / 500000000) * 500000000;
      return Math.round(n / 5000000000) * 5000000000;
    }

    function formatHebrew(n) {
      if (n >= 1e9) {
        const v = n / 1e9;
        const vStr = v % 1 === 0 ? v.toFixed(0) : v.toFixed(1);
        return vStr + ' ××™×œ×™××¨×“ â‚ª';
      }
      if (n >= 1e6) {
        const v = n / 1e6;
        const vStr = v % 1 === 0 ? v.toFixed(0) : v.toFixed(1);
        return vStr + ' ××™×œ×™×•×Ÿ â‚ª';
      }
      if (n >= 1e3) {
        const v = n / 1e3;
        const vStr = v % 1 === 0 ? v.toFixed(0) : v.toFixed(1);
        return v.toLocaleString('he', {maximumFractionDigits: 0}) + ' ××œ×£ â‚ª';
      }
      return 'â‚ª' + n.toLocaleString('he');
    }

    function getScaleWord(n) {
      if (n >= 100e9) return '(×××•×ª ××™×œ×™××¨×“×™×)';
      if (n >= 10e9) return '(×¢×©×¨×•×ª ××™×œ×™××¨×“×™×)';
      if (n >= 1e9) return '(××™×œ×™××¨×“×™×)';
      if (n >= 100e6) return '(×××•×ª ××™×œ×™×•× ×™×)';
      if (n >= 10e6) return '(×¢×©×¨×•×ª ××™×œ×™×•× ×™×)';
      if (n >= 1e6) return '(××™×œ×™×•× ×™×)';
      if (n >= 100e3) return '(×××•×ª ××œ×¤×™×)';
      if (n >= 10e3) return '(×¢×©×¨×•×ª ××œ×¤×™×)';
      if (n >= 1e3) return '(××œ×¤×™×)';
      return '';
    }

    function onCalcSlider() {
      const pos = parseInt(document.getElementById('calcSlider').value);
      const val = sliderToValue(pos);
      document.getElementById('calcInput').value = val;
      updateCalculator();
    }

    function getCalcAnalogy(valB) {
      // Extreme high range
      if (valB >= 628) return { text: "×›×œ ×ª×§×¦×™×‘ ×”××“×™× ×” ×œ×©× ×” ×©×œ××” ğŸ‡®ğŸ‡±", color: "#7eb8f7" };
      if (valB >= 300) return { text: "×›××¢×˜ ××—×¦×™×ª ××›×œ ×ª×§×¦×™×‘ ×”××“×™× ×”", color: "#ff6688" };
      if (valB >= 150) return { text: "×”×•×¦××•×ª ×”×—×™× ×•×š ×•×”×‘×¨×™××•×ª ×™×—×“ ×œ×©× ×” ×©×œ××”", color: "#3b82f6" };
      if (valB >= 120) return { text: "×›×œ ×ª×§×¦×™×‘ ×”×‘×™×˜×—×•×Ÿ (×¦×”\"×œ + ××©×˜×¨×”)", color: "#ef4444" };
      if (valB >= 95) return { text: "×ª×§×¦×™×‘ ×¦×”\"×œ ×”×©× ×ª×™ ×›×•×œ×•", color: "#ef4444" };
      if (valB >= 85) return { text: "×›×œ ×ª×§×¦×™×‘ ×”×—×™× ×•×š ×©×œ ×™×©×¨××œ ×œ×©× ×”", color: "#3b82f6" };
      if (valB >= 75) return { text: "×©×™×¨×•×ª ×”×—×•×‘ ×”×œ××•××™ ×›×•×œ×• (×¨×™×‘×™×ª ×¢×œ 628 ××™×œ×™××¨×“)", color: "#f59e0b" };
      if (valB >= 70) return { text: "×”×¨×•×•×—×” ×•×”×‘×™×˜×•×— ×”×œ××•××™ (×§×¦×‘××•×ª) ×œ×©× ×”", color: "#93c5fd" };
      if (valB >= 65) return { text: "×›×œ ×ª×§×¦×™×‘ ×”×‘×¨×™××•×ª â€” ×‘×ª×™ ×—×•×œ×™× ×•×§×•×¤×•×ª ×—×•×œ×™×", color: "#60a5fa" };
      if (valB >= 45) return { text: "×ª×§×¦×™×‘ ×”×××©×œ ×•×”××™× ×”×œ ×›×•×œ×• (×××©×œ×” ×•×›× ×¡×ª)", color: "#8b5cf6" };
      if (valB >= 40) return { text: "×›×œ ×”×ª×©×ª×™×•×ª ×•×”×¨×›×‘×•×ª ×©×œ ×”××“×™× ×”", color: "#10b981" };
      if (valB >= 28) return { text: "×ª×§×¦×™×‘ ×›×œ ×”××•× ×™×‘×¨×¡×™×˜××•×ª ×•×”××›×œ×œ×•×ª", color: "#06b6d4" };
      if (valB >= 25) return { text: "×ª×§×¦×™×‘ ×”××©×˜×¨×” ×•×”×‘×™×˜×—×•×Ÿ ×”×¤× ×™××™ ×›×•×œ×•", color: "#f87171" };
      if (valB >= 22) return { text: "×ª×§×¦×™×‘ ××•\"×¤ ×•×—×“×©× ×•×ª (Hi-Tech) ×œ×©× ×”", color: "#fb923c" };
      if (valB >= 20) return { text: "×”×‘×–×‘×•×– ×”×‘×™×•×¨×•×§×¨×˜×™ ×”×©× ×ª×™ (×”×¢×¨×›×”) ğŸ’¸", color: "#ef4444" };
      if (valB >= 18) return { text: "×ª×§×¦×™×‘ ×›×œ ×”×™×©×™×‘×•×ª ×•××•×¡×“×•×ª ×”×“×ª", color: "#ec4899" };
      if (valB >= 15) return { text: "×ª×§×¦×™×‘ ×”×“×™×•×¨ ×•×”×©×™×›×•×Ÿ (×¡×‘×¡×•×“ ×“×™×¨×•×ª)", color: "#34d399" };
      if (valB >= 12) return { text: "×ª×§×¦×™×‘ ×”×—×§×œ××•×ª ×•×”×’× ×ª ×”×¡×‘×™×‘×” ×™×—×“", color: "#a3e635" };
      if (valB >= 10) return { text: "10 ××™×œ×™××¨×“ â‚ª â€” ×›××• ×œ×‘× ×•×ª 20 ×‘×ª×™ ×—×•×œ×™× ×’×“×•×œ×™×", color: "#60a5fa" };
      if (valB >= 5) return { text: "×ª×§×¦×™×‘ ×§×•××œ×™×¦×™×•× ×™ × ×•×¡×£ ×©×œ×", color: "#f97316" };
      if (valB >= 2) return { text: "2 ××™×œ×™××¨×“ â‚ª â€” ×›××• 4,000 ×“×™×¨×•×ª ×‘×ª×œ ××‘×™×‘", color: "#34d399" };
      if (valB >= 1) return { text: "××™×œ×™××¨×“ â‚ª â€” ×›××• 10,000 ××•×¨×™× ×‘××©×š ×©× ×”", color: "#3b82f6" };
      if (valB >= 0.5) return { text: "×—×¦×™ ××™×œ×™××¨×“ â€” ×›××• ×¨×›×‘×ª ×§×œ×” ×‘×¢×™×¨ ×‘×™× ×•× ×™×ª", color: "#10b981" };
      if (valB >= 0.2) return { text: "200 ××™×œ×™×•×Ÿ â€” ×›××• ×‘×™\"×¡ ×ª×™×›×•×Ÿ ×—×“×© ×‘×›×œ ×¢×™×¨", color: "#3b82f6" };
      if (valB >= 0.1) return { text: "100 ××™×œ×™×•×Ÿ â€” 200 ×××‘×•×œ× ×¡×™× ××¦×•×™×“×™×", color: "#60a5fa" };
      if (valB >= 0.05) return { text: "50 ××™×œ×™×•×Ÿ â€” ×¤×¨×©×ª ×©×—×™×ª×•×ª ×’×“×•×œ×”", color: "#f59e0b" };
      if (valB >= 0.01) return { text: "10 ××™×œ×™×•×Ÿ â€” ×‘× ×™×™×ª ×’×Ÿ ×™×œ×“×™× ××¤×•××¨", color: "#3b82f6" };
      if (valB >= 0.005) return { text: "5 ××™×œ×™×•×Ÿ â€” ×ª×™×§ ××›×™×¤×” ×›×œ×›×œ×™ ×’×“×•×œ", color: "#7eb8f7" };
      if (valB >= 0.002) return { text: "2 ××™×œ×™×•×Ÿ â€” ×¢×œ×•×ª ×××•×¦×¢×ª ×©×œ ×ª×™×§ ××›×™×¤×”", color: "#7eb8f7" };
      if (valB >= 0.001) return { text: "××™×œ×™×•×Ÿ â‚ª â€” ×¨×›×‘ ××©×•×¨×™×™×Ÿ ×œ×¦×”\"×œ", color: "#ef4444" };
      if (valB >= 0.0005) return { text: "×—×¦×™ ××™×œ×™×•×Ÿ â€” ×“×™×¨×” ×‘×¤×¨×™×¤×¨×™×”", color: "#34d399" };
      if (valB >= 0.0002) return { text: "200 ××œ×£ â€” ×”×•× ××ª ××¢\"× ×§×˜× ×”", color: "#6b7280" };
      if (valB >= 0.0001) return { text: "100 ××œ×£ â€” ××©×›×•×¨×ª ×©× ×ª×™×ª ×××•×¦×¢×ª", color: "#aaa" };
      return { text: "×¢×©×¨×•×ª ××œ×¤×™× â€” ×“××™ ×©×›×™×¨×•×ª ×©× ×ª×™×™×", color: "#888" };
    }

    function updateCalculator() {
      const rawVal = parseFloat(document.getElementById('calcInput').value) || 1000;
      const val = rawVal / 1e9; // Convert â‚ª to Billions

      // Update Hebrew display
      const display = document.getElementById('calcAmountDisplay');
      display.textContent = formatHebrew(rawVal) + ' ' + getScaleWord(rawVal);

      // Update dynamic analogy
      const salaryAnalogy = (val / TOTAL * 10000).toFixed(val < 0.01 ? 3 : 2);
      const context = getCalcAnalogy(val);
      document.getElementById('calcAnalogy').innerHTML = `
        <div style="font-size:0.95rem; color:#dde; margin-bottom:6px;">
          ğŸ’¸ <strong>×××©×›×•×¨×ª â‚ª10,000</strong> = ×œ×”×¤×¡×™×“ <strong style="color:#7eb8f7; font-size:1.1rem;">â‚ª${salaryAnalogy}</strong>
        </div>
        <div style="font-size:0.85rem; color:${context.color};">
          â‰ˆ ${context.text}
        </div>`;

      const res = document.getElementById('calcResults');
      const fmtPct = (v) => {
        if (v < 0.0001) return v.toFixed(7) + '%';
        if (v < 0.01) return v.toFixed(5) + '%';
        if (v < 1) return v.toFixed(3) + '%';
        return v.toFixed(2) + '%';
      };

      const perspectives = [
        { lbl: "××ª×•×š ×¡×š ×›×œ ×”×ª×§×¦×™×‘", p: fmtPct(val / TOTAL * 100) },
        { lbl: "××ª×•×š ×ª×§×¦×™×‘ ×”×‘×™×˜×—×•×Ÿ", p: fmtPct(val / 120 * 100) },
        { lbl: "××ª×•×š ×ª×§×¦×™×‘ ×”×—×™× ×•×š ×•×”×‘×¨×™××•×ª", p: fmtPct(val / 220 * 100) },
        { lbl: "××ª×•×š ×©×™×¨×•×ª ×”×—×•×‘ (×¨×™×‘×™×ª)", p: fmtPct(val / 75 * 100) },
      ];

      res.innerHTML = perspectives.map(p => `
    <div class="calc-card">
      <div class="calc-card-val">${p.p}</div>
      <div class="calc-card-lbl">${p.lbl}</div>
    </div>
  `).join('');
    }

    function showTT(e, cell, pct) {
      const tt = document.getElementById('tooltip');
      const an = (cell.v / TOTAL * 10000).toFixed(0);
      tt.innerHTML = `<div class="tt-title">${cell.name} ${cell.sub}</div>
    <div class="tt-row"><span style="color:#99a;font-size:.78rem">${cell.d}</span></div>
    <div class="tt-row"><span>×¡×›×•×:</span><span class="tt-val">&#8362;${cell.v} ××™×œ×™××¨×“</span></div>
    <div class="tt-row"><span>××”×ª×§×¦×™×‘:</span><span class="tt-val">${pct}%</span></div>
    <div class="tt-row"><span>×× ×œ×•×’×™×” (×-&#8362;10K):</span><span class="tt-val">&#8362;${an}</span></div>`;
      tt.style.display = 'block'; moveTT(e);
    }
    function moveTT(e) {
      const tt = document.getElementById('tooltip');
      tt.style.left = (e.clientX + 14) + 'px'; tt.style.top = (e.clientY - 10) + 'px';
    }
    function hideTT() { document.getElementById('tooltip').style.display = 'none'; }

    function openExpanded(cell, pct) {
      hideTT();
      const overlay = document.getElementById('tmOverlay');
      const exp = document.getElementById('tmExpanded');
      const an = (cell.v / TOTAL * 10000).toFixed(0);
      const perCapita = (cell.v * 100).toLocaleString();

      exp.style.background = `linear-gradient(135deg, ${cell.c}, ${cell.c}dd)`;
      exp.innerHTML = `
        <button class="exp-close" onclick="closeExpanded()" aria-label="×¡×’×•×¨">&times;</button>
        <div class="exp-name">${cell.name}</div>
        <div class="exp-sub">${cell.sub}</div>
        <div class="exp-desc">${cell.d}</div>
        <div class="exp-stats">
          <div class="exp-stat-row">
            <span class="exp-stat-label">×¡×›×•×</span>
            <span class="exp-stat-val">â‚ª${cell.v} ××™×œ×™××¨×“</span>
          </div>
          <div class="exp-stat-row">
            <span class="exp-stat-label">××”×ª×§×¦×™×‘</span>
            <span class="exp-stat-val">${pct}%</span>
          </div>
          <div class="exp-stat-row">
            <span class="exp-stat-label">×œ× ×¤×© (×©× ×ª×™)</span>
            <span class="exp-stat-val">â‚ª${perCapita}</span>
          </div>
          <div class="exp-stat-row">
            <span class="exp-stat-label">×× ×œ×•×’×™×” (×-â‚ª10K)</span>
            <span class="exp-stat-val">â‚ª${an}</span>
          </div>
        </div>`;

      // Trigger reflow then activate
      overlay.style.display = 'block';
      exp.style.display = 'flex';
      requestAnimationFrame(() => {
        overlay.classList.add('active');
        exp.classList.add('active');
      });
    }

    function closeExpanded() {
      const overlay = document.getElementById('tmOverlay');
      const exp = document.getElementById('tmExpanded');
      overlay.classList.remove('active');
      exp.classList.remove('active');
      setTimeout(() => {
        overlay.style.display = 'none';
        exp.style.display = 'none';
      }, 300);
    }

    function syncInputs(sourceId, targetId, callback) {
      const source = document.getElementById(sourceId);
      const target = document.getElementById(targetId);
      target.value = source.value;
      callback();
    }

    window.addEventListener('load', () => { renderTreemap(); renderPerCapita(); renderGlobal(); updateCalculator(); updatePersonalTax(); });
    window.addEventListener('resize', renderTreemap);
    window.addEventListener('keydown', e => { if (e.key === 'Escape') closeExpanded(); });
  </script>
</body>

</html>